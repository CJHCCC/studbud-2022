<div class="col-12">		
    <div align="center" id="banner" style="height: 140px"><span class="text-danger" style="font-size: 5.5rem">43:23</span><br><span class="text-danger" style="font-size: 1.2rem">当前第 1 轮，共 1 轮</span></div>

    <br>	
    ﻿



<table width="100%" align="center" border="0">
<tbody>
<tr>
  <td rowspan="1" align="center" valign="top">
    



<script>var start_audio = new Audio("/static/Japanese Temple Bell Small-SoundBible.com-113624364.mp3");
var rest_audio = new Audio("/static/service-bell_daniel_simion.mp3");
var text = document.title;
var banner_html = "";
if (document.getElementById("banner") != null) banner_html = document.getElementById("banner").innerHTML;
var start_time = Number(new Date());
var tomato_minutes;
var rest_minutes;
var loosen_minutes;
var tomato_length;
var rest_length;
var loosen_length;
var looping_number;
var cur_loop_num;
var timerID;
var surfix = "";
var working = "N";
var looping = "Y";
var muted = "Y";
var confirmed_tomatos = new Array();
var sign_in = false;
if (document.getElementById('sign_out') != null) sign_in = true;
function get_ISO_datetime() {
    var date = new Date(); // Or the date you'd like converted.
    //console.log(new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString())
    return new Date(date.getTime() - date.getTimezoneOffset() * 60000).toISOString();
}
function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');
    //console.log(document.cookie)
    for(var i = 0; i < ca.length; i++){
        var c = ca[i].trim();
        if (c.indexOf(name) == 0) return decodeURI(c.substring(name.length, c.length));
    }
    return "";
}
function setCookie(cname, cvalue, exdays) {
    var d = new Date();
    d.setTime(d.getTime() + exdays * 86400000);
    var expires = "expires=" + d.toGMTString();
    document.cookie = cname + "=" + encodeURI(cvalue) + "; " + expires;
//console.log( cname + "=" + cvalue + "; " + expires+"; domain=www.tomatolist.com")
}
function newtext() {
    clearTimeout(timerID);
    duration = (Number(new Date()) - start_time) / 1000;
    rest_seconds = tomato_length - duration;
    minutes_left = parseInt(rest_seconds / 60);
    seconds_part = parseInt(rest_seconds % 60);
    if (String(seconds_part).length < 2) seconds_part = "0" + seconds_part;
    if (surfix == "⌛︎") surfix = "⏳︎";
    else surfix = "⌛︎";
    if (working != "Y") surfix = "☕";
    min_sec = minutes_left + ":" + seconds_part;
    if (document.getElementById("banner") != null) {
        h = '<span class="text-';
        if (working == "Y") h += 'danger';
        else h += 'secondary';
        h += '" style="font-size:5.5rem">' + min_sec + '</span>';
        if (looping_number > 0) {
            h += '<br><span class="text-';
            if (working == "Y") h += 'danger';
            else h += 'secondary';
            h += '" style="font-size:1.2rem">当前第 ' + cur_loop_num + ' 轮';
            h += '，共 ' + looping_number + ' 轮</span>';
        }
        document.getElementById("banner").innerHTML = h;
    }
    /*if (document.getElementById("cur_loop_num") != null){
document.getElementById('cur_loop_num').innerText = cur_loop_num;
if (working == "Y"){
    document.getElementById("cur_loop_num_line").setAttribute("class","text-danger")
}
else{
    document.getElementById("cur_loop_num_line").setAttribute("class","text-secondary")
}
}*/ title = min_sec + ' ';
    percent = parseInt(100 * rest_seconds / tomato_length);
    $('#pb').attr('aria-valuenow', percent).css('width', percent + '%');
    $('#pb').text(min_sec);
    var next_timeout = true;
    if (rest_seconds >= 0) {
        //Only show minutes not seconds, if more than 3 minutes of working
        if (rest_seconds > 180) title = minutes_left + ' ';
        nChar = 4;
        clocks_to_show = Math.ceil(percent * nChar / 100);
        for(var i = 0; i < clocks_to_show; i++)title += surfix;
        for(var i = 0; i < nChar - clocks_to_show; i++)title += '─';
        if (rest_seconds > tomato_length - 6) {
            if (seconds_part % 2 == 0) ;
            else title = "🔔🔔🔔";
        }
    } else {
        // Changing mode from working to resting, or vice vesa
        window.focus();
        rest_seconds = 0;
        start_time = Number(new Date());
        if (working == "Y") {
            working = "N";
            tomato_length = rest_minutes * 60;
            $("#pb").removeClass("bg-danger");
            $("#pb").addClass("bg-secondary");
            if (muted == "N") rest_audio.play();
            NotifyMe('开始休息啦！');
            insert_unconfirmed_tomato(tomato_minutes);
        } else {
            working = "Y";
            cur_loop_num += 1;
            tomato_length = tomato_minutes * 60;
            $("#pb").removeClass("bg-secondary");
            $("#pb").addClass("bg-danger");
            if (muted == "N") start_audio.play();
            if (cur_loop_num > looping_number || looping_number == 0) {
                //looping == 'N';
                cur_loop_num = 0;
                NotifyMe('休息结束啦！');
                next_timeout = false;
                working = "N";
            } else NotifyMe('休息结束，开始工作啦！');
        }
        setCookie("working", working, 1);
        setCookie("cur_loop_num", cur_loop_num, 1);
        setCookie("start_time", start_time, 1);
    }
    document.title = title;
    if (next_timeout == true) timerID = setTimeout("newtext()", 1000);
    else end();
}
function save_checked_value() {
    looping_value = "N";
    if (document.getElementById('looping') != null) {
        if (document.getElementById('looping').checked) looping_value = "Y";
    }
    muted_value = "N";
    if (document.getElementById('muted').checked) muted_value = "Y";
    tomato_minutes = document.getElementById('tomato_minutes').value;
    rest_minutes = document.getElementById('rest_minutes').value;
    loosen_minutes = document.getElementById('loosen_minutes').value;
    looping_number = document.getElementById('looping_number').value;
    if (tomato_minutes * rest_minutes * loosen_minutes * looping_number * 0 == 0) setCookie('checked_value', JSON.stringify([
        looping_value,
        muted_value,
        tomato_minutes,
        rest_minutes,
        loosen_minutes,
        looping_number
    ]), 15);
    load_checkbox_value();
}
function load_checkbox_value() {
    var values = getCookie('checked_value');
    looping = "Y";
    muted = "Y";
    tomato_minutes = 25;
    rest_minutes = 5;
    loosen_minutes = 10;
    looping_number = 1;
    if (values.length == 2) {
        looping = values[0];
        muted = values[1];
    }
    if (values.length > 2) {
        var value_list = JSON.parse(values);
        looping = value_list[0];
        muted = value_list[1];
        tomato_minutes = value_list[2];
        rest_minutes = value_list[3];
        loosen_minutes = value_list[4];
        looping_number = value_list[5];
    }
    tomato_length = tomato_minutes * 60;
    rest_length = rest_minutes * 60;
    loosen_length = loosen_minutes * 60;
    if (document.getElementById('tomato_minutes') != null) {
        document.getElementById('tomato_minutes').value = tomato_minutes;
        document.getElementById('rest_minutes').value = rest_minutes;
        document.getElementById('looping_number').value = looping_number;
        document.getElementById('loosen_minutes').value = loosen_minutes;
        document.getElementById('muted').checked = muted == 'Y';
    }
    if (document.getElementById('start_button') != null) {
        document.getElementById('start_button').innerHTML = "开始计时<span class='d-none d-xl-inline'>" + tomato_minutes + "分钟</span>";
        document.getElementById('rest_button').innerHTML = "开始休息<span class='d-none d-xl-inline'>" + rest_minutes + "分钟</span>";
    }
    if (document.getElementById('loosen_button') != null) document.getElementById('loosen_button').innerHTML = "长段休息<span class='d-none d-xl-inline'>" + loosen_minutes + "分钟</span>";
}
function get_display_time(total_minutes) {
    total_hours = Math.floor(total_minutes / 60);
    minutes = total_minutes % 60;
    display_time = '';
    if (total_hours > 0) display_time = total_hours + '小时';
    if (minutes > 0) display_time = display_time + minutes + '分钟';
    if (display_time == '') display_time = '0分钟';
    return display_time;
}
function insert_unconfirmed_tomato(minutes) {
    var str_time_now = get_ISO_datetime();
    var id = str_time_now;
    unconfirmed_tomatos = new Array();
    str_unconfirmed_tomatos = getCookie('unconfirmed_tomatos');
    if (str_unconfirmed_tomatos != '') unconfirmed_tomatos = JSON.parse(str_unconfirmed_tomatos);
    unconfirmed_tomatos.push([
        id,
        id.substr(11, 5),
        minutes
    ]);
    setCookie('unconfirmed_tomatos', JSON.stringify(unconfirmed_tomatos), 1);
    refresh_unconfirmed_tomatos();
}
function refresh_confirmed_tomatos() {
    var str_time_now = get_ISO_datetime();
    var total_focus_time = 0;
    var total_tomato_number = 0;
    for(var i = 0; i < confirmed_tomatos.length; i++){
        var tomato_id = confirmed_tomatos[i][0];
        if (tomato_id.substr(0, 10) == str_time_now.substr(0, 10)) {
            if (document.getElementById(tomato_id) == null) document.getElementById('good_tomatos').innerHTML += '<div id="' + tomato_id + '" class="col-4 col-md-3 col-lg-2 mb-1 px-1"><a class="btn btn-danger btn-sm btn-block rounded-pill" href="show_tomato?et=' + tomato_id + '">' + confirmed_tomatos[i][1] + ' - ' + get_display_time(confirmed_tomatos[i][2]) + '</a></div>';
            total_focus_time += confirmed_tomatos[i][2];
            total_tomato_number += 1;
        }
    }
    document.getElementById('total_focus_time').innerText = get_display_time(total_focus_time);
    document.getElementById('tomato_number').innerText = total_tomato_number;
}
function refresh_unconfirmed_tomatos() {
    var str_time_now = get_ISO_datetime();
    str_unconfirmed_tomatos = getCookie('unconfirmed_tomatos');
    unconfirmed_tomatos = new Array();
    if (str_unconfirmed_tomatos != '') unconfirmed_tomatos = JSON.parse(str_unconfirmed_tomatos);
    if (document.getElementById('tomato_records') != null) {
        var HTML = document.getElementById('tomato_records').innerHTML;
        for(var i = 0; i < unconfirmed_tomatos.length; i++)if (document.getElementById(unconfirmed_tomatos[i][0]) == null) {
            id = unconfirmed_tomatos[i][0];
            HTML += '<div class="row" id="' + id + '"><div class="alert alert-dark rounded-pill col-12" >' + unconfirmed_tomatos[i][1] + ' - 您刚刚专注了' + unconfirmed_tomatos[i][2] + '分钟：感觉如何？';
            HTML += '<span class="badge badge-pill badge-danger text-light font-weight-bolder" role="button" onclick="confirm_tomato(\'' + id + '\',' + unconfirmed_tomatos[i][2] + ',\'' + unconfirmed_tomatos[i][1] + '\')">富有成效</span> ';
            HTML += '<span class="badge badge-pill badge-secondary text-light font-weight-bolder"  role="button" onclick="confirm_tomato(\'' + id + '\',-1,0)">可以忽略</span></div>';
            HTML += '</div>';
        }
        document.getElementById('tomato_records').innerHTML = HTML;
    }
}
function confirm_tomato(id, minutes, end_time) {
    var thisNode = document.getElementById(id);
    thisNode.parentNode.removeChild(thisNode);
    str_unconfirmed_tomatos = getCookie('unconfirmed_tomatos');
    unconfirmed_tomatos = new Array();
    if (str_unconfirmed_tomatos != '') unconfirmed_tomatos = JSON.parse(str_unconfirmed_tomatos);
    var i = 0;
    for(i = 0; i < unconfirmed_tomatos.length; i++)if (unconfirmed_tomatos[i][0] == id) unconfirmed_tomatos.splice(i, 1);
    setCookie('unconfirmed_tomatos', JSON.stringify(unconfirmed_tomatos), 1);
    if (minutes >= 0) {
        confirmed_tomatos.push([
            id,
            end_time,
            minutes
        ]);
        //console.log([id, end_time, minutes]);
        cleans_data();
        refresh_confirmed_tomatos();
        sync_tomato_cloud();
    }
    setTimeout(function() {
        document.getElementById('day_bar').data = document.getElementById('day_bar').data;
    }, 1500);
}
function start() {
    clearTimeout(timerID);
    if (muted == "N") start_audio.play();
    start_time = Number(new Date());
    working = "Y";
    cur_loop_num = 1;
    //console.log(start_time);
    //console.log(working);
    //console.log(cur_loop_num);
    setCookie("start_time", start_time, 1);
    setCookie("working", working, 1);
    setCookie("cur_loop_num", cur_loop_num, 1);
    //console.log(getCookie("start_time"));
    //console.log(getCookie("working"));
    //console.log(getCookie("cur_loop_num"));
    auto_start();
}
function rest() {
    if (working == "Y") {
        duration_mintues = parseInt((Number(new Date()) - start_time) / 1000 / 60);
        insert_unconfirmed_tomato(duration_mintues);
        clearTimeout(timerID);
        start_time = Number(new Date());
        working = "N";
        setCookie("start_time", start_time, 1);
        setCookie("working", working, 1);
        auto_start();
    }
}
function loosen() {
    if (working == "Y") {
        duration_mintues = parseInt((Number(new Date()) - start_time) / 1000 / 60);
        insert_unconfirmed_tomato(duration_mintues);
        clearTimeout(timerID);
        start_time = Number(new Date());
        working = "L";
        setCookie("start_time", start_time, 1);
        setCookie("working", working, 1);
        auto_start();
    }
}
function end() {
    if (working == "Y") {
        duration_mintues = parseInt((Number(new Date()) - start_time) / 1000 / 60);
        insert_unconfirmed_tomato(duration_mintues);
    }
    clearTimeout(timerID);
    document.title = text;
    if (document.getElementById("banner") != null) document.getElementById("banner").innerHTML = banner_html;
    $('#pb').attr('aria-valuenow', 0).css('width', '0%');
    $('#pb').text("");
    working = "N";
    setCookie("start_time", 0, 1);
    setCookie("working", working, 1);
    setCookie("cur_loop_num", 0, 1);
    cur_loop_num = 0;
    if (document.getElementById("cur_loop_num") != null) {
        document.getElementById("cur_loop_num").innerText = cur_loop_num;
        document.getElementById("cur_loop_num_line").setAttribute("class", "text-secondary");
    }
}
function auto_start() {
    //console.log(getCookie("start_time"));
    //console.log(getCookie("working"));
    //console.log(getCookie("cur_loop_num"));
    cleans_data();
    load_checkbox_value();
    if (getCookie('start_time') == "") return;
    cur_loop_num = Number(getCookie('cur_loop_num'));
    cookie_working = getCookie('working');
    if (cookie_working == "Y") {
        working = "Y";
        tomato_length = tomato_minutes * 60;
        $("#pb").removeClass("bg-secondary");
        $("#pb").addClass("bg-danger");
    } else {
        if (cookie_working == "L") {
            working = "L";
            tomato_length = loosen_minutes * 60;
        } else {
            working = "N";
            tomato_length = rest_minutes * 60;
        }
        $("#pb").removeClass("bg-danger");
        $("#pb").addClass("bg-secondary");
    }
    time_now = Number(new Date());
    if (time_now - Number(getCookie('start_time')) < tomato_length * 1000) {
        start_time = Number(getCookie('start_time'));
        timerID = setTimeout("newtext()", 10);
    }
}
function NotifyMe(content) {
    if (!window.Notification) ;
    else // check if permission is already granted
    if (Notification.permission == 'granted') // show notification here
    var notify = new Notification('番茄·人生：通知', {
        body: content,
        icon: 'https://www.tomatolist.com/static/tomato.png',
        silent: true
    });
}
function allow_notify() {
    if (window.Notification) Notification.requestPermission();
}
function auto_hide_notify_btn() {
    if (window.Notification) {
        if (Notification.permission == 'granted') document.getElementById('allow_notify_btn').style.display = "none";
    }
}
function cleans_data() {
    var str_time_now = get_ISO_datetime();
    unconfirmed_tomatos = new Array();
    str_unconfirmed_tomatos = getCookie('unconfirmed_tomatos');
    if (str_unconfirmed_tomatos != '') unconfirmed_tomatos = JSON.parse(str_unconfirmed_tomatos);
    for(var i = 0; i < unconfirmed_tomatos.length; i++){
        if (unconfirmed_tomatos[i][0].length == 12) unconfirmed_tomatos[i][0] = str_time_now.substr(0, 10) + "T" + unconfirmed_tomatos[i][0] + "Z";
        if (unconfirmed_tomatos[i][0] > str_time_now) unconfirmed_tomatos.splice(i, 1);
    }
    setCookie('unconfirmed_tomatos', JSON.stringify(unconfirmed_tomatos), 1);
    for(var i = 0; i < confirmed_tomatos.length; i++){
        if (confirmed_tomatos[i][0].length == 12) confirmed_tomatos[i][0] = str_time_now.substr(0, 10) + "T" + confirmed_tomatos[i][0] + "Z";
        if (confirmed_tomatos[i][0] > str_time_now) confirmed_tomatos.splice(i, 1);
        if (confirmed_tomatos[i][0].substr(0, 10) != str_time_now.substr(0, 10)) confirmed_tomatos.splice(i, 1);
    }
}
function sync_tomato_cloud() {
    var str_tomato_list = JSON.stringify(confirmed_tomatos);
    var str_date = get_ISO_datetime().substr(0, 10);
    var data = 'tomatos_json=';
    data += encodeURIComponent(str_tomato_list);
    data += '&date=';
    data += encodeURIComponent(str_date);
    var xhr = new XMLHttpRequest();
    xhr.onload = function() {
        cleans_data();
    };
    xhr.open('POST', 'add_tomatos.html', false);
    //xhr.withCredentials = true;
    xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
    xhr.send(data);
}

</script>

<div class="row no-gutters ">
<div class="pr-1 pr-md-0 col-5 col-md-3 col-xl-2">
<span class="btn btn btn-outline-danger btn-block rounded-pill" id="start_button" onclick="start()" role="button" "="">开始计时<span class="d-none d-xl-inline">44分钟</span></span>
</div>


<div class=" col-2 col-md-5 col-xl-7 px-md-1">

<div class="progress  rounded-pill" style="height: 38px">
  <div class="progress-bar progress-bar-striped bg-danger" role="progressbar" aria-valuenow="98" aria-valuemin="0" aria-valuemax="100" style="width: 98%" id="pb">43:23</div>
</div>


</div>


<div class="pl-1 pl-md-0 col-5 col-md-3 col-xl-2">
<span class="btn btn btn-outline-secondary btn-block rounded-pill" id="rest_button" onclick="rest()" role="button">开始休息<span class="d-none d-xl-inline">6分钟</span></span>
</div>

<div class="offset-5 col-2 offset-md-0 col-md-1 pt-3 pt-md-0 pl-md-1">
<span class="btn btn btn-secondary btn-block rounded-pill font-weight-bold" onclick="end()" role="button">×</span>
</div>
</div>



    
<script>auto_start();

</script>
  </td>
</tr>
<tr>
  <td rowspan="1" valign="top" align="center">
    <div class="row mt-4">
        <div class="col-12 text-secondary" align="center">
            番茄：<input class="rounded rounded-3 text-secondary" style="text-align: center; border: 1px solid #ddd" size="3" id="tomato_minutes" name="tomato_length" onchange="save_checked_value()"> 分钟&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <span class="btn btn btn-outline-secondary rounded-pill" id="loosen_button" onclick="loosen()" roll="button">长段休息<span class="d-none d-xl-inline">10分钟</span></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            休息：<input class="rounded rounded-3 text-secondary" style="text-align: center; border: 1px solid #ddd" size="3" id="rest_minutes" name="rest_length" onchange="save_checked_value()"> 分钟					
        </div>
    </div>
  </td>
</tr>
</tbody>
</table>
</div>